<html>
  <head>
    <title>Android 与 H5 视频交互的故事 - stormzha</title>
    <link href='/images/fav.png' rel='shortcut icon'>
<link href='/atom.xml' rel='alternate' type='application/rss+xml'>
<link rel="stylesheet" href="/css/style.css">
<link rel="stylesheet" href="/css/highlight.css">
<link rel="stylesheet" href="/css/responsive.css">
<script src="/js/jquery.js"></script>
<script src="/js/basics.js"></script>
<meta content='width=device-width, initial-scale=1.0, user-scalable=no' name='viewport'>
<meta content='text/html; charset=utf-8' http-equiv='content-type'>


  </head>
  <body>
    <header>
  <a id='go-back-home' href='/'><img src='/images/scribble.png' alt='Home' width='53' height='59'></a>
  <p>stormzha</p>
  <p>做好今天的自己！</p>
</header>

    <div id='container'>
      <div class='block'>
  
    <a class='main' href='/'>Blog</a>
  
    <a class='main' href='/about/index.html'>About</a>
  
    <a class='main' href='mailto:stormzha@163.com'>Email</a>
  
    <a class='main' href='https://github.com/stormzha'>Github</a>
  
</div>

      <section class='paging'>
  
  
    <div class='right'>
      <a href='/2017/03/31/build/'>
        ›
      </a>
    </div>
  
</section>

      <div class='content'>
        <section class='post'>
          <h1>
            <div class='date'>2017-04-01</div>
            Android 与 H5 视频交互的故事
          </h1>
          <p>最近在做一个电影社区讨论平台的项目 , 性质类似于「豆瓣」那种 , APP 足够轻量 , 因为涉及到原生的很少 , 大多是与 H5 交互 , 特此来记录一下最近的点滴。</p>
<h3 id="1-android-播放H5-视频设置全屏"><a href="#1-android-播放H5-视频设置全屏" class="headerlink" title="1. android 播放H5 视频设置全屏"></a>1. android 播放H5 视频设置全屏</h3><p>对于android客户端直接访问的 H5 页面来说 , H5 自己则提供了视频全屏播放的属性设置 , 但是光有这点是完全不够的 , 因为我们还得在 android 端完成一系列的处理。</p>
<p><strong>让视频在各个 Android 版本都能够正常播放</strong></p>
<p>在AndroidManifest.xml中声明HardwareAccelerate的标志，一般是添加在Activity的级别上。代码如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">activity</span> <span class="attr">...</span> <span class="attr">android:hardwareAccelerated</span>=<span class="string">"true"</span> &gt;</span></div></pre></td></tr></table></figure>
<p>下面引申一下HardwareAccelerate声明的方式：</p>
<p>(a).如果需要声明整个应用都要加速，则在Application级别下面进行声明：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt; <span class="attr">application</span> <span class="attr">...</span> <span class="attr">android:hardwareAccelerated</span> =<span class="string">"true"</span>&gt;</span></div></pre></td></tr></table></figure>
<p>(b).如果需要某个Activity加速，则可以进行下面的声明：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">activity</span> <span class="attr">...</span> <span class="attr">android:hardwareAccelerated</span>=<span class="string">"true"</span> &gt;</span></div></pre></td></tr></table></figure>
<p>或者在代码里面进行动态的声明：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">getWindow.setFlags(WindowManager.LayoutParams.FLAG_HARDWARE_ACCELERATED,</div><div class="line">WindowManager.LayoutParams.FLAG_HARDWARE_ACCELERATED);</div></pre></td></tr></table></figure>
<p>(c).如果Application和Activity都声明了HardwareAccelerate，但是由于某些特殊原因，一些View不需要硬件加速，那么在View里面设置：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">view.setLayerType(View.LAYER_TYPE_SOFTWARE, null);</div></pre></td></tr></table></figure>
<p>完成声明操作后，基本上WebView就能够很好的支持在页面上播放视频了，下面展示的是在Html5上的Viedeo的声明方法：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">video</span> <span class="attr">width</span>=<span class="string">"305"</span> <span class="attr">height</span>=<span class="string">"305"</span> <span class="attr">controls</span>=<span class="string">"controls"</span> <span class="attr">preload</span>=<span class="string">"none"</span> <span class="attr">poster</span>=<span class="string">"http://****.png"</span> &gt;</span></div><div class="line">              <span class="tag">&lt;<span class="name">source</span> <span class="attr">src</span>=<span class="string">"http://*****.mp4"</span> <span class="attr">type</span>=<span class="string">"video/mp4"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">video</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></div></pre></td></tr></table></figure>
<p>单单在 H5 端做了处理是不够的 , 以下是支持网页视频全屏播放以及退出的解决方案：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebVideoActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</div><div class="line">  </div><div class="line">    <span class="keyword">private</span> WebView webView;</div><div class="line"></div><div class="line">    <span class="comment">/** 视频全屏参数 */</span></div><div class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> FrameLayout.LayoutParams COVER_SCREEN_PARAMS = <span class="keyword">new</span> FrameLayout.LayoutParams(ViewGroup.LayoutParams.MATCH_PARENT, ViewGroup.LayoutParams.MATCH_PARENT);</div><div class="line">    <span class="keyword">private</span> View customView;</div><div class="line">    <span class="keyword">private</span> FrameLayout fullscreenContainer;</div><div class="line">    <span class="keyword">private</span> WebChromeClient.CustomViewCallback customViewCallback;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle bundle)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(bundle);</div><div class="line">        setContentView(R.layout.activity_xx);</div><div class="line">        webView = (WebView) findViewById(R.id.xx);</div><div class="line">        initWebView();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onStop</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onStop();</div><div class="line">        webView.reload();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/** 展示网页界面 **/</span></div><div class="line">　　<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initWebView</span><span class="params">()</span> </span>&#123;</div><div class="line">        WebChromeClient wvcc = <span class="keyword">new</span> WebChromeClient();</div><div class="line">        WebSettings webSettings = webView.getSettings();</div><div class="line">        webSettings.setJavaScriptEnabled(<span class="keyword">true</span>);</div><div class="line">        webSettings.setUseWideViewPort(<span class="keyword">true</span>); <span class="comment">// 关键点</span></div><div class="line">        webSettings.setAllowFileAccess(<span class="keyword">true</span>); <span class="comment">// 允许访问文件</span></div><div class="line">        webSettings.setSupportZoom(<span class="keyword">true</span>); <span class="comment">// 支持缩放</span></div><div class="line">        webSettings.setLoadWithOverviewMode(<span class="keyword">true</span>);</div><div class="line">        webSettings.setCacheMode(WebSettings.LOAD_NO_CACHE); <span class="comment">// 不加载缓存内容</span></div><div class="line"></div><div class="line">        webView.setWebChromeClient(wvcc);</div><div class="line">        WebViewClient wvc = <span class="keyword">new</span> WebViewClient() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">shouldOverrideUrlLoading</span><span class="params">(WebView view, String url)</span> </span>&#123;</div><div class="line">                webView.loadUrl(url);</div><div class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line">        webView.setWebViewClient(wvc);</div><div class="line"></div><div class="line">        webView.setWebChromeClient(<span class="keyword">new</span> WebChromeClient() &#123;</div><div class="line"></div><div class="line">            <span class="comment">/*** 视频播放相关的方法 **/</span></div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> View <span class="title">getVideoLoadingProgressView</span><span class="params">()</span> </span>&#123;</div><div class="line">                FrameLayout frameLayout = <span class="keyword">new</span> FrameLayout(WebVideoActivity.<span class="keyword">this</span>);</div><div class="line">                frameLayout.setLayoutParams(<span class="keyword">new</span> LayoutParams(LayoutParams.MATCH_PARENT, LayoutParams.MATCH_PARENT));</div><div class="line">                <span class="keyword">return</span> frameLayout;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onShowCustomView</span><span class="params">(View view, CustomViewCallback callback)</span> </span>&#123;</div><div class="line">                showCustomView(view, callback);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onHideCustomView</span><span class="params">()</span> </span>&#123;</div><div class="line">                hideCustomView();</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line"></div><div class="line">        <span class="comment">// 加载Web地址</span></div><div class="line">        webView.loadUrl(webUrl);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/** 视频播放全屏 **/</span></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">showCustomView</span><span class="params">(View view, CustomViewCallback callback)</span> </span>&#123;</div><div class="line">        <span class="comment">// if a view already exists then immediately terminate the new one</span></div><div class="line">        <span class="keyword">if</span> (customView != <span class="keyword">null</span>) &#123;</div><div class="line">            callback.onCustomViewHidden();</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        WebVideoActivity.<span class="keyword">this</span>.getWindow().getDecorView();</div><div class="line"></div><div class="line">        FrameLayout decor = (FrameLayout) getWindow().getDecorView();</div><div class="line">        fullscreenContainer = <span class="keyword">new</span> FullscreenHolder(WebVideoActivity.<span class="keyword">this</span>);</div><div class="line">        fullscreenContainer.addView(view, COVER_SCREEN_PARAMS);</div><div class="line">        decor.addView(fullscreenContainer, COVER_SCREEN_PARAMS);</div><div class="line">        customView = view;</div><div class="line">        setStatusBarVisibility(<span class="keyword">false</span>);</div><div class="line">        customViewCallback = callback;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/** 隐藏视频全屏 */</span></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">hideCustomView</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (customView == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        setStatusBarVisibility(<span class="keyword">true</span>);</div><div class="line">        FrameLayout decor = (FrameLayout) getWindow().getDecorView();</div><div class="line">        decor.removeView(fullscreenContainer);</div><div class="line">        fullscreenContainer = <span class="keyword">null</span>;</div><div class="line">        customView = <span class="keyword">null</span>;</div><div class="line">        customViewCallback.onCustomViewHidden();</div><div class="line">        webView.setVisibility(View.VISIBLE);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/** 全屏容器界面 */</span></div><div class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">FullscreenHolder</span> <span class="keyword">extends</span> <span class="title">FrameLayout</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">FullscreenHolder</span><span class="params">(Context ctx)</span> </span>&#123;</div><div class="line">            <span class="keyword">super</span>(ctx);</div><div class="line">            setBackgroundColor(ctx.getResources().getColor(android.R.color.black));</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTouchEvent</span><span class="params">(MotionEvent evt)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setStatusBarVisibility</span><span class="params">(<span class="keyword">boolean</span> visible)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> flag = visible ? <span class="number">0</span> : WindowManager.LayoutParams.FLAG_FULLSCREEN;</div><div class="line">        getWindow().setFlags(flag, WindowManager.LayoutParams.FLAG_FULLSCREEN);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onKeyUp</span><span class="params">(<span class="keyword">int</span> keyCode, KeyEvent event)</span> </span>&#123;</div><div class="line">        <span class="keyword">switch</span> (keyCode) &#123;</div><div class="line">        <span class="keyword">case</span> KeyEvent.KEYCODE_BACK:</div><div class="line">            <span class="comment">/** 回退键 事件处理 优先级:视频播放全屏-网页回退-关闭页面 */</span></div><div class="line">            <span class="keyword">if</span> (customView != <span class="keyword">null</span>) &#123;</div><div class="line">                hideCustomView();</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (webView.canGoBack()) &#123;</div><div class="line">                webView.goBack();</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                finish();</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        <span class="keyword">default</span>:</div><div class="line">            <span class="keyword">return</span> <span class="keyword">super</span>.onKeyUp(keyCode, event);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在onShowCustomView方法中，将获取到的view放到当前Activity的最上方，在onHideCustomView中，将之前的view隐藏或者删除，将原来被覆盖的webview放回来。</p>
<h3 id="2-android-4-X-不兼容-H5-端视频黑屏问题"><a href="#2-android-4-X-不兼容-H5-端视频黑屏问题" class="headerlink" title="2. android  4.X 不兼容 H5 端视频黑屏问题"></a>2. android  4.X 不兼容 H5 端视频黑屏问题</h3><p><strong>Android 4.4 中播放 HTML5 视频的 Bug</strong></p>
<p>应用中使用了 Webview 播放 HTML5 视频，代码如下： </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">video</span> <span class="attr">width</span>=<span class="string">"480"</span> <span class="attr">height</span>=<span class="string">"280"</span> <span class="attr">poster</span>=<span class="string">"test.jpg"</span> <span class="attr">src</span>=<span class="string">"test.mp4"</span> <span class="attr">preload</span>=<span class="string">"auto"</span>&gt;</span><span class="tag">&lt;/<span class="name">video</span>&gt;</span></div></pre></td></tr></table></figure>
<p>在4.3版本之前播放正常，新版本中播放时只能听到声音，而画面停留在最初的画面，也就是poster属性中的图片，但不会显示视频动画，只有点击暂停按钮，然后再次点击播放按钮时，视频动画才会显示正常。</p>
<p>网上查阅了很多国外论坛，发现两个类似的反馈，但解决方法不同，其中的一个办法是使用CSS3的-webkit-transform: translate3d(0, 0, 0)属性强制打开3D渲染，可以使视频播放正常，但这种方法会导致初始的poster图片只显示一下，然后一闪而过停留在视频播放界面，点击播放时，视频播放倒是一切正常。</p>
<p>问题可能是由于preload属性引起，只有设定preload=”none”才可以显示视频，官方已经确认了这个bug，并表示已经解决，下个版本会更新。但经我测试，单独设置preload=”none”并不会完全解决此问题，视频仍旧只有声音，画面停留在初始界面。</p>
<p>经我多次试验，将上述两种方法结合起来，最终解决了这个问题，代码如下： </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">video</span> <span class="attr">width</span>=<span class="string">"480"</span> <span class="attr">height</span>=<span class="string">"280"</span> <span class="attr">poster</span>=<span class="string">"test.jpg"</span> <span class="attr">src</span>=<span class="string">"test.mp4"</span> <span class="attr">preload</span>=<span class="string">"none"</span> &gt;</span><span class="tag">&lt;/<span class="name">video</span>&gt;</span></div></pre></td></tr></table></figure>
<p>这个Bug产生的原因我认为是在视频开始播放时没有启动3D加速，导致原始的poster图片未被刷新到视频画面。设置preload=”none”禁止了视频的自动载入，确保了poster画面被正确载入；同时在点击播放视频时，-webkit-transform: translate3d(0, 0, 0)确保打开了3D加速，自动刷新了poster的原始画面。</p>
<p>当然以上原因都为猜测，解决办法也是临时的，因为这不符合HTML5标签的原始定义，未来还要看官方的下一个Android版本是否解决掉这个Bug。</p>
<p>比较稳定的版本开源video</p>
<p><a href="https://github.com/videojs/video.js/releases" target="_blank" rel="external">https://github.com/videojs/video.js/releases</a></p>
<h3 id="3-加载网页端视频时的布局问题"><a href="#3-加载网页端视频时的布局问题" class="headerlink" title="3. 加载网页端视频时的布局问题"></a>3. 加载网页端视频时的布局问题</h3><p>比如我在视频上加入改变声音时的图标 , 或者你有自己的需求要加入 TextView 之类的 , 上代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> ImageView showhide;  <span class="comment">//返回键</span></div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * 设置返回键</div><div class="line"> */</div><div class="line">showhide.setBackgroundResource(R.drawable.ic_back);</div><div class="line">LayoutParams params = <span class="keyword">new</span> FrameLayout.LayoutParams(<span class="number">80</span>, <span class="number">70</span>);</div><div class="line">showhide.setLayoutParams(params);</div><div class="line">showhide.setVisibility(View.GONE);  <span class="comment">//设置不可见</span></div><div class="line">video.addView(showhide);            <span class="comment">//添加视图到布局</span></div></pre></td></tr></table></figure>
<p>也许大家在看了最后一行代码后会觉得我的布局是 VideoView , 告诉你 , 并不是！</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">FrameLayout</span></span></div><div class="line">    <span class="attr">android:id</span>=<span class="string">"@+id/video_view"</span></div><div class="line">    <span class="attr">android:layout_width</span>=<span class="string">"fill_parent"</span></div><div class="line">    <span class="attr">android:layout_height</span>=<span class="string">"fill_parent"</span></div><div class="line">    <span class="attr">android:visibility</span>=<span class="string">"gone"</span> &gt;</div><div class="line"><span class="tag">&lt;/<span class="name">FrameLayout</span>&gt;</span></div></pre></td></tr></table></figure>
<p>我只是加了个帧布局而已 , 因为我们的 APP 将轻量发挥到了极致 , 况且这里完全一个帧布局就可以搞定 , H5 已经完成了对视频的绝对控制权 , 再者这里需要加布局的话直接加进去是不行的 , 还是得在动态的控制 , 所以一般是实现起来都是以上的方式！</p>
<h3 id="4-横屏下上下滑动改变声音以及亮度"><a href="#4-横屏下上下滑动改变声音以及亮度" class="headerlink" title="4. 横屏下上下滑动改变声音以及亮度"></a>4. 横屏下上下滑动改变声音以及亮度</h3><p><strong>Android 4.4 低版本屏幕滑动事件问题</strong></p>
<p>关于这个你以为我要长篇大论了吗？不不不 , 这个问题的解决方案很简单 , 但却让我一通好找。</p>
<p>在这里我没有去重写父类的 onScoll 方法 , 而是选择重写 onTouchEvent 方法 , 上代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTouch</span><span class="params">(View v, MotionEvent event)</span> </span>&#123;</div><div class="line">	v.setClickable(<span class="keyword">true</span>); <span class="comment">//处理4.x系统下不能进入滑动事件</span></div><div class="line">	<span class="keyword">switch</span> (event.getAction()) &#123;</div><div class="line">	<span class="keyword">case</span> MotionEvent.ACTION_DOWN:</div><div class="line">		<span class="keyword">break</span>;</div><div class="line">	<span class="keyword">case</span> MotionEvent.ACTION_MOVE:</div><div class="line">		<span class="keyword">break</span>;</div><div class="line">	<span class="keyword">case</span> MotionEvent.ACTION_UP:</div><div class="line">		<span class="keyword">break</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>没错 , 第三行就是我的解决方案 , 关于低版本这里需要代码设置事件！</p>
<p>关于滑动屏幕控制声音亮度我也就不多说了 , 这种功能实现起来很简单。我参考的如下方法：</p>
<p><a href="http://www.lai18.com/content/1438500.html?from=cancel" target="_blank" rel="external">滑动控制声音亮度 + 全屏播放</a></p>
<h3 id="5-H5-视频自带横屏切换后的屏幕自动旋转"><a href="#5-H5-视频自带横屏切换后的屏幕自动旋转" class="headerlink" title="5. H5 视频自带横屏切换后的屏幕自动旋转"></a>5. H5 视频自带横屏切换后的屏幕自动旋转</h3><p>说到这里我就要嘲笑一下自己了 , 我本来以为 H5 页面的视屏全屏我没有办法让她反向旋转 , 唯一可行的办法可能就是通过监测手机旋转角度 , 去动态控制布局文件的翻转角度 , 我真的这么干了…..</p>
<p>等我发觉不必这么麻烦的时候 , 我试了一下我曾经几乎写到吐的方式 , 算了 , 上代码吧！也不怕被人笑话了。</p>
<p>我们需要在处理整个事件的方法体内部加上这段初始化角度监听 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 进入全屏的时候</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onShowCustomView</span><span class="params">(View view, CustomViewCallback callback)</span> </span>&#123;</div><div class="line">   AlbumOrientationEventListener mAlbumOrientationEventListener = <span class="keyword">new</span>      AlbumOrientationEventListener(act, SensorManager.SENSOR_DELAY_NORMAL);  </div><div class="line">   <span class="keyword">if</span> (mAlbumOrientationEventListener.canDetectOrientation()) &#123;  </div><div class="line">   mAlbumOrientationEventListener.enable();  </div><div class="line">   &#125; <span class="keyword">else</span> &#123;  </div><div class="line">     Log.d(<span class="string">"chengcj1"</span>, <span class="string">"Can't Detect Orientation"</span>);  </div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>比如我则是在事件进入全屏处理的时候加入了引入</p>
<p>然后通过内部类的方式实现整个功能</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">	 * 用户手机横竖屏监听类</div><div class="line">	 * <span class="doctag">@author</span> MaiBenBen</div><div class="line">	 *</div><div class="line">	 */</div><div class="line">     <span class="class"><span class="keyword">class</span> <span class="title">AlbumOrientationEventListener</span> <span class="keyword">extends</span> <span class="title">OrientationEventListener</span> </span>&#123;  </div><div class="line">   </div><div class="line">	    <span class="function"><span class="keyword">public</span> <span class="title">AlbumOrientationEventListener</span><span class="params">(Context context)</span> </span>&#123;  </div><div class="line">	        <span class="keyword">super</span>(context);  </div><div class="line">	    &#125;  </div><div class="line">	          </div><div class="line">	    <span class="function"><span class="keyword">public</span> <span class="title">AlbumOrientationEventListener</span><span class="params">(Context context, <span class="keyword">int</span> rate)</span> </span>&#123;  </div><div class="line">	        <span class="keyword">super</span>(context, rate);  </div><div class="line">	    &#125;  	  </div><div class="line">	    <span class="meta">@Override</span>  </div><div class="line">	    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onOrientationChanged</span><span class="params">(<span class="keyword">int</span> orientation)</span> </span>&#123;  </div><div class="line">	    	<span class="comment">//Log.e("屏幕旋转度数","" +orientation);</span></div><div class="line">	    	<span class="keyword">int</span> screenOrientation = act.getResources().getConfiguration().orientation;</div><div class="line">	        <span class="comment">/*if (orientation == OrientationEventListener.ORIENTATION_UNKNOWN) &#123;  </span></div><div class="line">	            return;  </div><div class="line">	        &#125;  */</div><div class="line">	  </div><div class="line">	        <span class="keyword">if</span> (((orientation &gt;= <span class="number">0</span>) &amp;&amp; (orientation &lt; <span class="number">45</span>)) || (orientation &gt; <span class="number">315</span>)) &#123;<span class="comment">//设置竖屏</span></div><div class="line">                <span class="keyword">if</span> (screenOrientation != ActivityInfo.SCREEN_ORIENTATION_PORTRAIT &amp;&amp; orientation != ActivityInfo.SCREEN_ORIENTATION_REVERSE_PORTRAIT) &#123;</div><div class="line">                	act.setRequestedOrientation(ActivityInfo.SCREEN_ORIENTATION_PORTRAIT);</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (orientation &gt; <span class="number">225</span> &amp;&amp; orientation &lt; <span class="number">315</span>) &#123; <span class="comment">//设置横屏</span></div><div class="line">                <span class="keyword">if</span> (screenOrientation != ActivityInfo.SCREEN_ORIENTATION_LANDSCAPE) &#123;</div><div class="line">                	act.setRequestedOrientation(ActivityInfo.SCREEN_ORIENTATION_LANDSCAPE);</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (orientation &gt; <span class="number">45</span> &amp;&amp; orientation &lt; <span class="number">135</span>) &#123;<span class="comment">// 设置反向横屏</span></div><div class="line">                <span class="keyword">if</span> (screenOrientation != ActivityInfo.SCREEN_ORIENTATION_REVERSE_LANDSCAPE) &#123;</div><div class="line">                 act.setRequestedOrientation(ActivityInfo.SCREEN_ORIENTATION_REVERSE_LANDSCAPE);</div><div class="line">                &#125;</div><div class="line">            &#125; </div><div class="line">	    &#125;  </div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p>其实就是这个万年不变的老方式了！所以我们在处理程序这件事上 , 应该是尽可能的想出简单的方式来实现功能 , 否则就跟我一样浪费这么多时间却做得是无用功！</p>

          <br>
<p>stormzha</p>
<p><img src='/images/scribble3.png' alt='scribble'></p>

        </section>
      </div>
      
      <div class='block'>
  
    <a class='main' href='/'>Blog</a>
  
    <a class='main' href='/about/index.html'>About</a>
  
    <a class='main' href='mailto:stormzha@163.com'>Email</a>
  
    <a class='main' href='https://github.com/stormzha'>Github</a>
  
</div>

    </div>
    <footer>
  <span class='muted'>&copy; John Doe. All Rights Reserved.</span><br>
  <a href='https://github.com/saintwinkle/hexo-theme-scribble' class='muted'>built with Hexo using Scribble theme</a>
  <br>
  <br>
  <img src='/images/scribble2.png' alt='scribble' />
</footer>

  </body>
</html>
